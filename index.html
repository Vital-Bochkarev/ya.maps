<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карта Яндекс — GeoJSON с мультиполигонами</title>
  <style>
    html,body { height:100%; margin:0; font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    #wrap { display:grid; grid-template-columns:360px 1fr; height:100%; }
    #list { border-right:1px solid #e5e7eb; overflow:auto; }
    #map  { width:100%; height:100%; }
    .list-header { position:sticky; top:0; background:#fff; z-index:1; padding:.5rem .75rem; border-bottom:1px solid #e5e7eb; font-weight:600; }
    table { width:100%; border-collapse:collapse; }
    thead th { text-align:left; font-weight:600; color:#6b7280; padding:.5rem .75rem; position:sticky; top:36px; background:#fff; border-bottom:1px solid #e5e7eb; }
    tbody td { padding:.5rem .75rem; border-bottom:1px solid #f3f4f6; vertical-align:top; }
    tbody tr { cursor:pointer; }
    tbody tr:hover { background:#f9fafb; }
    #diag { position:fixed; right:8px; bottom:8px; background:#111; color:#fff; padding:4px 8px; border-radius:6px; font:12px/1.3 monospace; opacity:.9; z-index:9999; }
  </style>
  <!-- ВСТАВЬТЕ свой ключ; координатный порядок long,lat -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&coordorder=longlat&apikey=743db4ac-b4fa-4b26-9e5d-a46953c1b951"></script>
</head>
<body>
  <div id="wrap">
    <aside id="list">
      <div class="list-header">Список объектов</div>
      <table>
        <thead>
          <tr><th style="width:55%">Городской округ</th><th>Название</th></tr>
        </thead>
        <tbody id="featList"><tr><td colspan="2">Загрузка…</td></tr></tbody>
      </table>
    </aside>
    <div id="map"></div>
  </div>
  <div id="diag">init…</div>

<script>
const SRC_GEOJSON =
  "https://gist.githubusercontent.com/Vital-Bochkarev/b96a1680d32b83086de812eddabb31cf/raw/69ce2f478a9f8990b482fdd6348de02387593212/map.geojson";

const esc  = s => String(s ?? '').replace(/[&<>\"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
const diag = t => { const el = document.getElementById('diag'); if (el) el.textContent = t; };

let map, om;

function buildList(fc){
  const tbody = document.getElementById('featList');
  tbody.innerHTML = '';
  fc.features.forEach((f, i) => {
    const p = f.properties || {};
    const okrug = p.Name ?? p.NAME ?? p.name ?? p.title ?? '—';
    const name  = p.description ?? '—';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${esc(okrug)}</td><td>${esc(name)}</td>`;
    tr.onclick = () => zoomToObject(i);
    tbody.appendChild(tr);
  });
}

function zoomToObject(id){
  try {
    const obj = om.objects.getById(id);
    if (!obj || !obj.geometry) return;
    // считаем bounds выбранного объекта безопасно
    const q = ymaps.geoQuery({ type:'FeatureCollection', features:[obj] });
    const b = q.getBounds();
    if (b) map.setBounds(b, { checkZoomRange:true, zoomMargin:20 });
  } catch(e){
    console.warn('bounds error', e);
  }
}

async function loadGeoJSON(){
  diag('Загрузка GeoJSON…');
  const r = await fetch(SRC_GEOJSON, { cache:'no-store' });
  if (!r.ok) throw new Error('HTTP '+r.status);
  const data = await r.json();

  // Гарантируем FeatureCollection и выдаём id по индексу
  const fc = (data?.type === 'FeatureCollection')
    ? data
    : { type:'FeatureCollection', features: (data?.type==='Feature' ? [data] : [{type:'Feature',geometry:data,properties:{}}]) };

  // Оставим только полигоны/мультиполигоны на всякий случай
  fc.features = (fc.features||[]).filter(f => f && f.geometry && (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon'));

  fc.features = fc.features.map((f, i) => ({ id:i, ...f }));

  // Добавляем в ObjectManager
  try {
    om.add(fc);
  } catch(e) {
    console.error('om.add failed', e);
    diag('Ошибка GeoJSON: не удалось добавить объекты');
    return;
  }

  // Стиль на все объекты
  om.objects.options.set({
    fillColor:   '#ff6699',
    fillOpacity: 0.6,
    strokeColor: '#ff0055',
    strokeOpacity: 1,
    strokeWidth: 2
  });

  // Подгоняем карту по всем объектам — через om.getBounds(), без geoQuery
  try {
    const b = om.getBounds && om.getBounds();
    if (b) map.setBounds(b, { checkZoomRange:true, zoomMargin:20 });
  } catch(e){
    console.warn('setBounds failed', e);
  }

  // Список
  buildList(fc);

  diag(`OK: объектов на карте: ${fc.features.length}`);
}

ymaps.ready(() => {
  // ВАЖНО: coordorder=longlat → центр задаём как [долгота, широта]
  map = new ymaps.Map('map', {
    center:[37.618423, 55.751244], // Москва (lon,lat)
    zoom:9,
    controls:['zoomControl','typeSelector','fullscreenControl']
  }, { suppressMapOpenBlock:true });

  // Слои Яндекса: Схема/Спутник/Гибрид через стандартный селектор
  map.controls.get('typeSelector').options.set('size','large');

  // ObjectManager (без кластеризации)
  om = new ymaps.ObjectManager({ clusterize:false, geoObjectOpenBalloonOnClick:false });
  map.geoObjects.add(om);

  loadGeoJSON().catch(e => { console.error(e); diag('Ошибка GeoJSON: ' + (e.message || e)); });
});
</script>
</body>
</html>
