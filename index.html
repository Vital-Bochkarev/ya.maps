<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карта (Leaflet + Яндекс тайлы) — GeoJSON</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body { height:100%; margin:0; font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    #wrap { display:grid; grid-template-columns:360px 1fr; height:100%; }
    #list { border-right:1px solid #e5e7eb; overflow:auto; }
    #map  { width:100%; height:100%; }
    .list-header { position:sticky; top:0; background:#fff; z-index:1; padding:.5rem .75rem; border-bottom:1px solid #e5e7eb; font-weight:600; }
    table { width:100%; border-collapse:collapse; }
    thead th { text-align:left; font-weight:600; color:#6b7280; padding:.5rem .75rem; position:sticky; top:36px; background:#fff; border-bottom:1px solid #e5e7eb; }
    tbody td { padding:.5rem .75rem; border-bottom:1px solid #f3f4f6; vertical-align:top; }
    tbody tr { cursor:pointer; }
    tbody tr:hover { background:#f9fafb; }
    #diag { position:fixed; right:8px; bottom:8px; background:#111; color:#fff; padding:4px 8px; border-radius:6px; font:12px/1.3 monospace; opacity:.85; z-index:9999; }
  </style>
</head>
<body>
  <div id="wrap">
    <aside id="list">
      <div class="list-header">Список объектов</div>
      <table>
        <thead>
          <tr><th style="width:55%">Городской округ</th><th>Название</th></tr>
        </thead>
        <tbody id="featList"><tr><td colspan="2">Загрузка…</td></tr></tbody>
      </table>
    </aside>
    <div id="map"></div>
  </div>
  <div id="diag">init…</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const SRC_GEOJSON =
      "https://gist.githubusercontent.com/Vital-Bochkarev/b96a1680d32b83086de812eddabb31cf/raw/69ce2f478a9f8990b482fdd6348de02387593212/map.geojson";

    const esc = s => String(s ?? '').replace(/[&<>\"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
    const setDiag = t => { const el = document.getElementById('diag'); if (el) el.textContent = t; };

    // Карта без атрибуции (флажок пропадёт)
    const map = L.map('map', { center: [55.75, 37.61], zoom: 8, attributionControl:false });
    L.tileLayer(
      'https://core-renderer-tiles.maps.yandex.net/tiles?l=map&x={x}&y={y}&z={z}&scale=1&lang=ru_RU',
      { maxZoom:19 }
    ).addTo(map);

    // Переворот координат [lng,lat] → [lat,lng]
    function flipCoords(coords) {
      if (typeof coords[0] === "number") {
        return [coords[1], coords[0]];
      }
      return coords.map(flipCoords);
    }
    function fixGeoJSON(fc) {
      const out = JSON.parse(JSON.stringify(fc));
      out.features.forEach(f=>{
        if (f.geometry?.coordinates) {
          f.geometry.coordinates = flipCoords(f.geometry.coordinates);
        }
      });
      return out;
    }

    const polyStyle = { color:'#ff0055', weight:2, fillColor:'#ff6699', fillOpacity:0.6 };
    const featureLayers=[];

    function buildList(fc, focus) {
      const tbody = document.getElementById('featList');
      tbody.innerHTML = '';
      fc.features.forEach((f,i)=>{
        const p=f.properties||{};
        const okrug = p.Name??p.name??'—';
        const name = p.description??'—';
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${esc(okrug)}</td><td>${esc(name)}</td>`;
        tr.onclick=()=>focus(i);
        tbody.appendChild(tr);
      });
    }

    fetch(SRC_GEOJSON).then(r=>r.json()).then(fc=>{
      const fixed = fixGeoJSON(fc);
      const layer = L.geoJSON(fixed,{
        style:polyStyle,
        onEachFeature:(feature,layer)=>{
          featureLayers.push(layer);
          const p=feature.properties||{};
          layer.bindPopup(`<b>${esc(p.description||"")}</b><br>${esc(p.Name||"")}`);
        }
      }).addTo(map);
      map.fitBounds(layer.getBounds());
      buildList(fixed,(i)=>{
        const l=featureLayers[i];
        if(l){ map.fitBounds(l.getBounds(),{padding:[20,20]}); l.openPopup(); }
      });
      setDiag(`OK: ${featureLayers.length} объектов`);
    }).catch(e=>{console.error(e); setDiag("Ошибка GeoJSON");});
  </script>
</body>
</html>
