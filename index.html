<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карта из GeoJSON (GeoObject)</title>
  <style>
    html,body { height:100%; margin:0; font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    #wrap { display:grid; grid-template-columns:360px 1fr; height:100%; }
    #list { border-right:1px solid #e5e7eb; overflow:auto; }
    #map { width:100%; height:100%; }
    .list-header { position:sticky; top:0; background:#fff; z-index:1; padding:.5rem .75rem; border-bottom:1px solid #e5e7eb; font-weight:600; }
    table { width:100%; border-collapse:collapse; }
    thead th { text-align:left; font-weight:600; color:#6b7280; padding:.5rem .75rem; position:sticky; top:36px; background:#fff; border-bottom:1px solid #e5e7eb; }
    tbody td { padding:.5rem .75rem; border-bottom:1px solid #f3f4f6; vertical-align:top; }
    tbody tr { cursor:pointer; }
    tbody tr:hover { background:#f9fafb; }
    .muted { color:#6b7280; }
    #diag { position:fixed; right:8px; bottom:8px; background:#111; color:#fff; padding:4px 8px; border-radius:6px; font:12px/1.3 monospace; opacity:.85; z-index:9999; }
  </style>

  <!-- Подключение Яндекс.Карт (вставьте свой API-ключ) -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&coordorder=longlat&apikey=743db4ac-b4fa-4b26-9e5d-a46953c1b951"></script>
</head>
<body>
  <div id="wrap">
    <aside id="list">
      <div class="list-header">Список объектов</div>
      <table>
        <thead>
          <tr><th style="width:55%">Городской округ</th><th>Название</th></tr>
        </thead>
        <tbody id="featList"><tr><td colspan="2" class="muted">Загрузка…</td></tr></tbody>
      </table>
    </aside>
    <div id="map"></div>
  </div>
  <div id="diag">init…</div>

  <script>
    // ---- Настройки
    const SRC_GEOJSON =
      "https://gist.githubusercontent.com/Vital-Bochkarev/b96a1680d32b83086de812eddabb31cf/raw/69ce2f478a9f8990b482fdd6348de02387593212/map.geojson";

    // ---- Утилиты
    const diag = t => { const el = document.getElementById('diag'); if (el) el.textContent = t; };
    const esc  = s => String(s ?? '').replace(/[&<>\"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));

    // GeoJSON → FeatureCollection
    function toFC(obj){
      if (obj?.type === 'FeatureCollection') return obj;
      if (obj?.type === 'Feature') return { type:'FeatureCollection', features:[obj] };
      return { type:'FeatureCollection', features:[{ type:'Feature', geometry:obj, properties:{} }] };
    }

    // Приводим координаты к числам в порядке [lon, lat]
    const num = v => { const n = Number(v); return Number.isFinite(n) ? n : NaN; };
    const normPair = p => [num(p[0]), num(p[1])];
    function normalizeGeom(g){
      if (!g) return g;
      const t = g.type, c = g.coordinates;
      if (t === 'Point') g.coordinates = normPair(c);
      else if (t === 'MultiPoint' || t === 'LineString') g.coordinates = (c||[]).map(normPair);
      else if (t === 'MultiLineString' || t === 'Polygon') g.coordinates = (c||[]).map(r => (r||[]).map(normPair));
      else if (t === 'MultiPolygon') g.coordinates = (c||[]).map(p => (p||[]).map(r => (r||[]).map(normPair)));
      else if (t === 'GeometryCollection') (g.geometries||[]).forEach(normalizeGeom);
      return g;
    }

    // Таблица
    function buildList(fc, focus){
      const tbody = document.getElementById('featList');
      tbody.innerHTML = '';
      if (!fc.features?.length){
        tbody.innerHTML = '<tr><td colspan="2" class="muted">Нет данных</td></tr>';
        return;
      }
      fc.features.forEach((f, i) => {
        const p = f.properties || {};
        const okrug = (p.Name ?? p.NAME ?? p.name ?? p.title ?? '—');
        const name  = (p.description ?? '—');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${esc(okrug)}</td><td>${esc(name)}</td>`;
        tr.onclick = () => focus(i);
        tbody.appendChild(tr);
      });
    }

    // ---- Рендер
    let map;
    const objects = []; // ymaps.GeoObject[]

    function overallBounds(){
      try {
        const col = new ymaps.GeoObjectCollection();
        objects.forEach(o => col.add(o));
        return col.getBounds();
      } catch { return null; }
    }

    async function loadAndRender(){
      const r = await fetch(SRC_GEOJSON, { cache:'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const raw = await r.json();
      const fc  = toFC(raw);
      fc.features.forEach(f => f.geometry && normalizeGeom(f.geometry));

      // Удаляем предыдущие, добавляем новые GeoObject с жирными стилями
      objects.forEach(o => map.geoObjects.remove(o));
      objects.length = 0;

      fc.features.forEach(f => {
        try {
          const obj = new ymaps.GeoObject(
            { geometry: f.geometry, properties: f.properties || {} },
            {
              fillColor:   '#ff0055',
              fillOpacity: 0.6,
              strokeColor: '#ff0055',
              strokeOpacity: 1,
              strokeWidth: 3,
              zIndex: 65000,
              zIndexHover: 65001,
              hasHint: false,
              hasBalloon: false,
              interactivityModel: 'default#geoObject'
            }
          );
          map.geoObjects.add(obj);
          objects.push(obj);
        } catch (e) {
          console.warn('skip feature', f.properties, e);
        }
      });

      // Таблица и управление зумом
      buildList(fc, (idx) => {
        const o = objects[idx];
        if (!o) return;
        const b = o.geometry.getBounds?.() || overallBounds();
        if (b) map.setBounds(b, { checkZoomRange:true });
      });

      const b = overallBounds();
      if (b) map.setBounds(b, { checkZoomRange:true });
      diag(`OK: добавлено объектов: ${objects.length}`);
    }

    ymaps.ready(() => {
      // coordorder=longlat → [lon, lat]
      map = new ymaps.Map('map', {
        center:[37.618423,55.751244],
        zoom:7,
        controls:['zoomControl','typeSelector','fullscreenControl']
      });
      loadAndRender().catch(e => { console.error(e); diag('Ошибка: ' + e.message); });
    });
  </script>
</body>
</html>
