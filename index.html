<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карта (Leaflet + Яндекс тайлы) — GeoJSON</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body { height:100%; margin:0; font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    #wrap { display:grid; grid-template-columns:360px 1fr; height:100%; }
    #list { border-right:1px solid #e5e7eb; overflow:auto; }
    #map  { width:100%; height:100%; }
    .list-header { position:sticky; top:0; background:#fff; z-index:1; padding:.5rem .75rem; border-bottom:1px solid #e5e7eb; font-weight:600; }
    table { width:100%; border-collapse:collapse; }
    thead th { text-align:left; font-weight:600; color:#6b7280; padding:.5rem .75rem; position:sticky; top:36px; background:#fff; border-bottom:1px solid #e5e7eb; }
    tbody td { padding:.5rem .75rem; border-bottom:1px solid #f3f4f6; vertical-align:top; }
    tbody tr { cursor:pointer; }
    tbody tr:hover { background:#f9fafb; }
    #diag { position:fixed; right:8px; bottom:8px; background:#111; color:#fff; padding:4px 8px; border-radius:6px; font:12px/1.3 monospace; opacity:.85; z-index:9999; }
  </style>
</head>
<body>
  <div id="wrap">
    <aside id="list">
      <div class="list-header">Список объектов</div>
      <table>
        <thead>
          <tr><th style="width:55%">Городской округ</th><th>Название</th></tr>
        </thead>
        <tbody id="featList"><tr><td colspan="2">Загрузка…</td></tr></tbody>
      </table>
    </aside>
    <div id="map"></div>
  </div>
  <div id="diag">init…</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Ваш GeoJSON
    const SRC_GEOJSON =
      "https://gist.githubusercontent.com/Vital-Bochkarev/b96a1680d32b83086de812eddabb31cf/raw/69ce2f478a9f8990b482fdd6348de02387593212/map.geojson";

    const esc = s => String(s ?? '').replace(/[&<>\"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
    const setDiag = t => { const el = document.getElementById('diag'); if (el) el.textContent = t; };

    // Карта: тайлы Яндекса (русские подписи)
    const map = L.map('map', { center: [55.751244, 37.618423], zoom: 8 });
    const yandexLayer = L.tileLayer(
      // схема (можно заменить на 'sat' для спутника или 'skl' для гибридных подписей)
      'https://core-renderer-tiles.maps.yandex.net/tiles?l=map&x={x}&y={y}&z={z}&scale=1&lang=ru_RU',
      { attribution: '© Яндекс' }
    ).addTo(map);

    // Список
    function buildList(fc, focus) {
      const tbody = document.getElementById('featList');
      tbody.innerHTML = '';
      if (!fc.features?.length) {
        tbody.innerHTML = '<tr><td colspan="2">Нет данных</td></tr>';
        return;
      }
      fc.features.forEach((f, i) => {
        const p = f.properties || {};
        const okrug = p.Name ?? p.NAME ?? p.name ?? p.title ?? '—';
        const name  = p.description ?? '—';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${esc(okrug)}</td><td>${esc(name)}</td>`;
        tr.onclick = () => focus(i);
        tbody.appendChild(tr);
      });
    }

    // Стиль полигонов — толстый и яркий
    const polyStyle = {
      color: '#ff0055',      // обводка
      weight: 3,
      opacity: 1,
      fillColor: '#ff6699',  // заливка
      fillOpacity: 0.6
    };

    // Хранилище слоёв по фичам для зума из списка
    const featureLayers = [];

    fetch(SRC_GEOJSON, { cache:'no-store' })
      .then(r => r.json())
      .then(fc => {
        // Отрисовка
        const layer = L.geoJSON(fc, {
          style: polyStyle,
          onEachFeature: (feature, layer) => {
            featureLayers.push(layer);
            const p = feature.properties || {};
            const okrug = p.Name ?? p.NAME ?? p.name ?? p.title ?? '';
            const name  = p.description ?? '';
            if (okrug || name) layer.bindPopup(`<b>${esc(name)}</b><br>${esc(okrug)}`);
          }
        }).addTo(map);

        // fitBounds
        try { map.fitBounds(layer.getBounds()); } catch {}

        // Список
        buildList(fc, (i) => {
          const l = featureLayers[i];
          if (l) {
            const b = l.getBounds?.();
            if (b && b.isValid()) map.fitBounds(b, { padding:[20,20] });
          }
        });

        setDiag(`OK: объектов на карте: ${featureLayers.length}`);
      })
      .catch(e => {
        console.error(e);
        setDiag('Ошибка загрузки GeoJSON');
      });
  </script>
</body>
</html>
