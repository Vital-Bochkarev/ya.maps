<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карта из GeoJSON</title>
  <style>
    html,body{height:100%;margin:0;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #wrap{display:grid;grid-template-columns:360px 1fr;height:100%}
    #list{border-right:1px solid #e5e7eb;overflow:auto}
    #map{width:100%;height:100%}
    .list-header{position:sticky;top:0;background:#fff;z-index:1;padding:.5rem .75rem;border-bottom:1px solid #e5e7eb;font-weight:600}
    table{width:100%;border-collapse:collapse}
    thead th{text-align:left;font-weight:600;color:#6b7280;padding:.5rem .75rem;position:sticky;top:36px;background:#fff;border-bottom:1px solid #e5e7eb}
    tbody td{padding:.5rem .75rem;border-bottom:1px solid #f3f4f6;vertical-align:top}
    tbody tr{cursor:pointer}
    tbody tr:hover{background:#f9fafb}
    #diag{position:fixed;right:8px;bottom:8px;background:#111;color:#fff;padding:4px 8px;border-radius:6px;font:12px/1.3 monospace;opacity:.85;z-index:9999}
  </style>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&coordorder=longlat&apikey=743db4ac-b4fa-4b26-9e5d-a46953c1b951"></script>
</head>
<body>
<div id="wrap">
  <aside id="list">
    <div class="list-header">Список объектов</div>
    <table>
      <thead><tr><th style="width:55%">Городской округ</th><th>Название</th></tr></thead>
      <tbody id="featList"><tr><td colspan="2">Загрузка…</td></tr></tbody>
    </table>
  </aside>
  <div id="map"></div>
</div>
<div id="diag">init…</div>

<script>
const SRC_GEOJSON="https://gist.githubusercontent.com/Vital-Bochkarev/b96a1680d32b83086de812eddabb31cf/raw/69ce2f478a9f8990b482fdd6348de02387593212/map.geojson";
const esc=s=>String(s??"").replace(/[&<>\"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch]));
const diag=t=>{const e=document.getElementById('diag'); if(e) e.textContent=t;};
function toFC(o){if(o?.type==="FeatureCollection")return o;if(o?.type==="Feature")return{type:"FeatureCollection",features:[o]};return{type:"FeatureCollection",features:[{type:"Feature",geometry:o,properties:{}}]}}
function num(v){const n=Number(v);return Number.isFinite(n)?n:NaN}
function normGeom(g){if(!g)return g;const t=g.type,c=g.coordinates;
 if(t==='Point')g.coordinates=[num(c[0]),num(c[1])];
 else if(t==='MultiPoint'||t==='LineString')g.coordinates=(c||[]).map(p=>[num(p[0]),num(p[1])]);
 else if(t==='MultiLineString'||t==='Polygon')g.coordinates=(c||[]).map(r=>r.map(p=>[num(p[0]),num(p[1])])); 
 else if(t==='MultiPolygon')g.coordinates=(c||[]).map(p=>p.map(r=>r.map(q=>[num(q[0]),num(q[1])])));
 else if(t==='GeometryCollection')(g.geometries||[]).forEach(normGeom); return g;}
function buildList(fc,focus){const tb=document.getElementById('featList');tb.innerHTML='';if(!fc.features?.length){tb.innerHTML='<tr><td colspan="2">Нет данных</td></tr>';return;}
 fc.features.forEach((f,i)=>{const p=f.properties||{}, city=p.Name??p.NAME??p.name??p.title??'—', name=p.description??'—';
   const tr=document.createElement('tr'); tr.innerHTML=`<td>${esc(city)}</td><td>${esc(name)}</td>`;
   tr.onclick=()=>focus(i,f); tb.appendChild(tr);});}
let map, objs=[];
function overallBounds(){try{const col=new ymaps.GeoObjectCollection();objs.forEach(o=>col.add(o));return col.getBounds();}catch{return null}}
async function loadAndRender(){
  const r=await fetch(SRC_GEOJSON,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
  const raw=await r.json(); const fc=toFC(raw); fc.features.forEach(f=>f.geometry&&normGeom(f.geometry));
  // рисуем по одному GeoObject (обход багов 2.1)
  objs.forEach(o=>map.geoObjects.remove(o)); objs.length=0;
  fc.features.forEach((f)=>{try{const o=new ymaps.GeoObject({geometry:f.geometry,properties:f.properties||{}},{
     fillColor:'#FF000088',strokeColor:'#FF0000',strokeWidth:2,hasHint:false,hasBalloon:false}); map.geoObjects.add(o); objs.push(o);}catch(e){console.warn('skip feature',f.properties,e);}});
  buildList(fc,(i)=>{const o=objs[i]; if(!o)return; const b=o.geometry.getBounds?.()||overallBounds(); if(b) map.setBounds(b,{checkZoomRange:true});});
  const b=overallBounds(); if(b) map.setBounds(b,{checkZoomRange:true}); diag(`OK: добавлено объектов: ${objs.length}`);
}
ymaps.ready(()=>{map=new ymaps.Map('map',{center:[37.618423,55.751244],zoom:7,controls:['zoomControl','typeSelector','fullscreenControl']}); loadAndRender().catch(e=>{console.error(e);diag('Ошибка: '+e.message)});});
</script>
</body>
</html>
